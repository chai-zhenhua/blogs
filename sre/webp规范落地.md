# WebP格式图片的规范和落地实践

  对于电商平台而言，图片、视频等静态资源的数量是很庞大的，而对这些庞大数量静态资源的管理无疑是抛给SRE团队的一个难题，因为他们在考虑资源的可用性和易用性之外更要计算性价比如何才能最优，因为一个优秀的SRE团队会追求对成本把控的极致。

  本篇文章我将会讲述我们是如何制定图片规范且持续性监控规范执行情况的闭环方案。当然在规范推进的过程中我们也不仅提升了用户体验也降低了IT成本，下面就和我一起走进这个项目吧！

## 1. 背景
  统一了图片的上传/存储/访问标准
  需要加载提速并且伴随着成本的下降（webp格式/切图），多次执行未果，最后标准也未能落地， 本篇文章就是基于SRE的风险闭环思想来最终推动和落地并且持续监控不规范的一个案例

  之前我们在图片/视频等静态资源的管理没有太过重视，但是随着数据量越来越大，业务逻辑越来越复杂，导致出现问题时的排查定位时间越来越长。于是在故障复盘会上我们终于下定决心要统一静态资源的上传方式，这一动作也是花费了不少的力气，因为涉及到梳理各业务对于静态资源的处理逻辑、新流程的设计、系统的开发以及协同各业务方对接到新系统，这部分暂不展开，值得一说的是历时三个月我们统一了对全平台静态资源的管理方式，我们内部称该静态资源管理系统为“资源中心”。有了资源中心之后对于静态资源的访问问题定位和解决都更加清晰明了。

  某天的晚上，我们接到用户的反馈说：“APP内的某个页面内的图片加载很慢几乎展示不了”，当然最终定位到的原因是用户当时处于弱网环境下，而反馈的页面内加载了很多图片，综合这两个因素才有了用户的这次反馈。基于这个问题我们进行了复盘，发现对应的页面所展示的图片是未经处理过的原图。这让人感到不可思议，为什么这么说呢？因为我们在很早之前就对图片的展示制定过规范且推进业务改造过，规范包括：优先使用WebP格式、对不同的场景使用不同的图片尺寸的缩略图等。于是乎我们又分析了下整个平台上的图片，发现使用WebP和缩略图的场景是比较少的。

  那么为什么会出现这种情况呢？我们分析总结了如下的几点原因：

     1. 人员流动性大
     2. 规范未全面覆盖到各业务线
     3. 缺乏对规范推进后的持续性监控和整改措施

  其中最主要的原因是 **缺乏对规范推进后的持续性监控和整改措施**，因为少了这一个步骤，在整个项目的生命周期里是没有完成闭环的，随着时间的推移那些当时的约定如果没有监督终将是会被遗弃的。

## 2. 改革
**从确立 全面支持webp的目标开始，包括支持webp和切图的底层能力，到开发介入整改不规范代码的过程， 到整个监控闭环体系的搭建： webp图片数量的趋势 切图尺寸的趋势 不是webp的请求数据收集（CDN日志），告警， 再到从根源上搜索不规范代码同步到持续改进平台追踪整个生命周期，再到周报， 形成一个完整的方案闭环**

  通过上面的介绍相信读者应该知道我们目前的问题是: **如何能够落地图片规范**。那么在这一部分我将会借助SRE的风险闭环思想来详细聊聊如何解决这个问题。

  **这里加一张闭环的⭕️图，写上一些流程上的文字**

  ### 2.1 确定目标
  问题确定之后，下一步是确定目标，以目标是否完成来佐证问题是否解决，这是一个比较可行的方法。那么围绕着如何能够落地图片规范这个问题我们制定了如下目标:

    1. 图片优先使用WebP格式
    2. 对所有展示图片的场景制定对应尺寸的缩略图
    3. 避免过多使用原图
    4. CDN服务的成本下降10%
    5. 可持续监控不规范使用方式并整改

  这五个目标将会作为根治该问题的方案，涵盖了规范的制定、执行、监控、整改一个闭环的流程， 同时我们附加了一个成本的目标，我们认为这一系列整改推进完成之后在成本上是有反馈的，最明显的当属CDN，因为在相同的请求下返回的数据越小CDN的计费流量就会越低，这也从侧面佐证了项目的意义。

  ### 2.2 拆解目标
  目标确定之后，下一步是对目标进行拆解、细化，制定具体的执行方案，各个击破。

  #### 2.2.1 图片优先使用WebP格式
  对于WebP格式大家或多或少可能都会有些了解，它是Google针对Web开发的一种轻量级的图片压缩格式，Google对它的介绍如下: 简单来说就是相比于PNG和JPEG格式在相同的质量下WebP的图片更小，因此在Web的传输上就会更快。
  ```
  WebP lossless images are 26% smaller in size compared to PNGs. WebP lossy images are 25-34% smaller than comparable JPEG images at equivalent SSIM quality index.
  ```
  另外当前主流的浏览器都支持了WebP，可以通过该网站查询浏览器对图片格式的支持，查询结果如图2-1所示
  ```
  https://caniuse.com/?search=webp
  ```

  那么对于一些老旧的设备不支持WebP的由前端展示时去判断用户设备是否支持，不支持时直接展示原始格式的图片，这个功能是支持的， 因为我们的存储里存放的是用户上传的原图，我们在用户发起请求时动态的去处理这些原图使之符合我们期望的格式， 这样就能防止一刀切无法动态应变。

  **图片访问流程图**


  #### 2.2.2 对所有展示图片的场景制定对应尺寸的缩略图
  有了WebP的能力之后，为了进一步减小数据大小，我们使用了缩略图，在不同的场景下使用不同尺寸的缩略图，比如：用户头像从之前的原图使用96px的缩略图，大小下降是很明显的。于是在这一方面我们也制定了图片尺寸展示的标准，如图2-2所示

      **图2-2 各场景和缩略图尺寸的对照**

  当然，这个规范是前端同事制定的。

  #### 2.2.3 避免过多使用原图
  原图指的是用户上传的原始图片，这种图片一般都比较大从3M到20M不等，如果不做些限制无论是对用户体验还是对企业的IT成本来说都没有什么好处

  对用户来说：网络质量差的时候页面加载缓慢，迟迟看不到想看的内容，很烦躁。

  对企业来说：CDN成本居高不下却还天天有用户投诉图片看不到， 心里苦。

  也许你会问不用原图会不会导致图片不清晰甚至失真呢？我说一下我们的处理方法：首先我们使用的是缩略图，指定宽度，高度自适应做等比缩放而不是裁剪，配合上述的场景根据前端盒子的大小匹配最适合的尺寸就不会模糊， 其次只会对图片做缩小而不会去做放大，这样就不会有失真的问题

  只在特定的场景去展示原图，比如当用户点击查看原图时。经过这两部的操作我们就进一步减少了响应数据的大小，那么在页面加载时就会更快一点。
  #### 2.2.4 CDN服务的成本下降10%
  经过上面的优化其实已经对CDN的成本产生了积极的影响， 我们只需要验证是否达到我们的预期目标即可

  ### 2.3 监控实现和风险闭环
  这里是本篇的一个核心点，因为没有监控就会重蹈覆辙，规范推进一定时间之后会被逐渐遗忘，就又回到了我们最开始的状态了。
  项目的核心点有两个， 首先是标准规范推进各业务线对接整改， 其次就是自动化的监控，持续性的对不符合规范的场景进行整改，达成一个流程上的闭环，才能真正意义上的完成这个项目。

  1. 对WebP数量的监控
  2. 对非WebP请求的监控
  3. 对没有使用通用组件的代码监控
  4. 周邮件总结同步上层领导

## 结果
结果的验证，总的请求图片大小是下降的， CDN成本是下降的， 规范形成了且落地了，得到了公司的认可

## 总结
